<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<ChartScript GroupBy="Always">
  <Columns>
    <Column DisplayName="Horizontal Axis" ColumnType="Groupable" IsGroupKey="true" />
    <Column DisplayName="Vertical Axis" ColumnType="Groupable" IsGroupKey="true" />
    <Column DisplayName="Size" ColumnType="Magnitude" IsOptional="true">
      <Parameter1 Name="Scale" Type="Enum" ValueDefinition="ZeroMax | MinMax | Log | Sqrt" />
    </Column>
    <Column DisplayName="Color" ColumnType="Magnitude" IsOptional="true">
      <Parameter1 Name="ColorSet" Type="Enum" ValueDefinition="YlGn|YlGnBu|GnBu|BuGn|PuBuGn|PuBu|BuPu|RdPu|PuRd|OrRd|YlOrRd|YlOrBr|Purples|Blues|Greens|Oranges|Reds|Greys|PuOr|BrBG|PRGn|PiYG|RdBu|RdGy|RdYlBu|Spectral|RdYlGn" />
      <Parameter2 Name="ColorScale" Type="Enum" ValueDefinition="ZeroMax | MinMax | Sqrt  | Log" />
    </Column>
  </Columns>
  <Icon FileName="punchcard.png"><![CDATA[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]]></Icon>
  <Script><![CDATA[function DrawChart(chart, data){
  
  var colorSet = data.columns.c3.parameter1;
  var colorScale = data.columns.c3.parameter2;
  
  var dim0 = d3.nest()
    .key(function(r){return r.c0.toString(); })
    .rollup(function(r){return r[0].c0 })
    .entries(data.rows)
    .map(function(g){return g.values;});
  
 var dim1 = d3.nest()
    .key(function(r){return r.c1.toString(); })
    .rollup(function(r){return r[0].c1 })
    .entries(data.rows)
    .map(function(g){return g.values;});

  var xRule = rule({
    _1 : 5,
    title : 15,
    _2 : 10, 
    labels : 110,
    _3 : 5,
    ticks: 4,
    content: '*',
    _4: 10,
  }, width);
  //xRule.debugX(chart)
  
  var yRule = rule({
    _1 : 5,
    content: '*',
    ticks: 4,
    _2 : 5,
    labels: 15,
    _3 : 10,
    title: 15,
    _4 : 5,
  }, height);
  //yRule.debugY(chart);
  
  var x = d3.scale.ordinal()
      .domain(dim0)
      .rangeBands([0, xRule.size('content')]);
  
  var y = d3.scale.ordinal()
      .domain(dim1)
      .rangeBands([0, yRule.size('content')]);
  
  var circleSize = Math.min(x.rangeBand(), y.rangeBand()) * 0.45;

  var area = data.columns.c2.token == null? null : scaleFor(data.columns.c2, data.rows.map(function(r){return r.c2;}), 0, circleSize * circleSize);
  
  var color = null;
  if(data.columns.c3.token != null)
  {
    var scaleFunc = scaleFor(data.columns.c3, data.rows.map(function(r){return r.c3;}), 0, 100, colorScale);
    
    var colorQuantizer = d3.scale.quantize()
        .domain([0, 100])
        .range(colorbrewer[colorSet][9]);
    
    color = function(v){return colorQuantizer(scaleFunc(v)); }
  }
  
  chart.append('svg:g').attr('class', 'x-line').attr('transform',  translate(xRule.start('content') + x.rangeBand() / 2, yRule.start('content')))
    .enterData(dim0, 'line', 'y-line')
     .attr('y2',  yRule.size('content'))
      .attr('x1', function (d) { return x(d); })
      .attr('x2', function (d) { return x(d); })
    .style('stroke', 'LightGray');
  
  chart.append('svg:g').attr('class', 'x-tick').attr('transform', translate(xRule.start('content') + x.rangeBand() / 2, yRule.start('ticks')))
    .enterData(dim0, 'line', 'x-tick')
      .attr('y2',  yRule.size('ticks'))
      .attr('x1', function (d) { return x(d); })
      .attr('x2', function (d) { return x(d); })
      .style('stroke', 'Black');
  
  chart.append('svg:g').attr('class', 'x-label').attr('transform', translate(xRule.start('content') + x.rangeBand() / 2, yRule.middle('labels')))
    .enterData(dim0, 'text', 'x-label')
    .attr('x', function (d) { return x(d); })
    .attr('dominant-baseline', 'middle')
    .attr('text-anchor', 'middle')
    .text(function (d) { return d.niceToString(); });
  
  chart.append('svg:g').attr('class', 'x-title').attr('transform', translate(xRule.middle('content'), yRule.middle('title')))
    .append('svg:text').attr('class', 'x-title')
    .attr('text-anchor', 'middle')
    .attr('dominant-baseline', 'middle')
    .text(data.columns.c0.title);
  

  
  chart.append('svg:g').attr('class', 'y-line').attr('transform', translate(xRule.start('content'), yRule.end('content') - y.rangeBand() / 2))
    .enterData(dim1, 'line', 'y-line')
    .attr('x2', xRule.size('content'))
    .attr('y1', function (t) { return -y(t); })
    .attr('y2', function (t) { return -y(t); })
    .style('stroke', 'LightGray');
  
  chart.append('svg:g').attr('class', 'y-tick').attr('transform', translate(xRule.start('ticks'), yRule.end('content') - y.rangeBand() / 2))
    .enterData(dim1, 'line', 'y-tick')
    .attr('x2', xRule.size('ticks'))
    .attr('y1', function (t) { return -y(t); })
    .attr('y2', function (t) { return -y(t); })
    .style('stroke', 'Black');
  
  chart.append('svg:g').attr('class', 'y-label').attr('transform',  translate(xRule.end('labels'), yRule.end('content') - y.rangeBand() / 2))
    .enterData(dim1, 'text', 'y-label')
    .attr('y', function (t) { return -y(t); })
    .attr('dominant-baseline', 'middle')
    .attr('text-anchor', 'end')
    .text(function (d) { return d.niceToString(); });
 
  chart.append('svg:g').attr('class', 'y-label').attr('transform', translate(xRule.middle('title'), yRule.middle('content')) + rotate(270))
    .append('svg:text').attr('class', 'y-label')
    .attr('text-anchor', 'middle')
    .attr('dominant-baseline', 'middle')
    .text(data.columns.c1.title);
  
   chart.enterData(data.rows, 'circle', 'punch').attr('transform', translate(xRule.start('content') + x.rangeBand() / 2, yRule.end('content') - y.rangeBand() / 2))
      .filter(function(r) {return r != undefined;})
      .attr('cx', function(r, i) { return x(r.c0); })
      .attr('cy', function(r) { return -y(r.c1); })
      .attr('r', function(r) { return area == null? circleSize: Math.sqrt(area(r.c2)); })
      .attr('fill', function(r) { return color == null? 'black':  color(r.c3); })
      .attr('fill-opacity', .4)
      .attr('stroke', function(r) { return color == null? 'black':  color(r.c3); })
      .attr('stroke-width', 2)
      .attr("shape-rendering","initial")
      .attr('data-click', function(r) { return getClickKeys(r, data.columns); })
      .append('svg:title')
      .text(function(r) { return r.c0.niceToString() + ', ' + r.c1.niceToString() + 
        (data.columns.c2.token == null? "" : ("\n" + data.columns.c2.title +": " +r.c2.niceToString()) ) +
        (data.columns.c3.token == null? "" : ("\n" +  data.columns.c3.title +": " +r.c3.niceToString()) ); });
  
   /*
   var color =  d3.scale.category20().domain($.map(series, function (s) { return s.dim1; }));
  
   var line = d3.svg.line()
    .x(function(r) { return x(r.c0); })
    .y(function(r) { return -y(r.c2); })
       .defined(function(r){return r != undefined;})
    .interpolate(data.columns.c2.parameter2);
  
  //paint graph - line
  chart.enterData(series, 'g', 'shape-serie').attr('transform', translate(xRule.start('content') + x.rangeBand() / 2, yRule.end('content')))
    .append('svg:path').attr('class', 'shape')
      .attr('stroke', function(s) { return getColor(s.dim1, color); })
      .attr('fill', 'none')
      .attr('stroke-width', 3)
      .attr('shape-rendering', 'initial')
      .attr('d', function(s) { return line(s.values0);});
      
  //paint graph - hover area trigger
  chart.enterData(series, 'g', 'hover-trigger-serie').attr('transform', translate(xRule.start('content') + x.rangeBand() / 2, yRule.end('content')))
    .enterData(function(s) { return s.values0; }, 'circle', 'point')
      .filter(function(r) {return r != undefined;})
      .attr('cx', function(r, i) { return x(r.c0); })
      .attr('cy', function(r) { return -y(r.c2); })
      .attr('r', function(r) { return 15; })
      .attr('fill', '#fff')
      .attr('fill-opacity', 0)
      .attr('stroke', 'none')
      .attr('data-click', function(r) { return getClickKeys(r, data.columns); })
      .append('svg:title')
      .text(function(r) { return r.c0.niceToString() + ', ' + r.c1.niceToString() + ': ' + r.c2.niceToString(); });
  
  //paint graph - points
  chart.enterData(series, 'g', 'point-serie').attr('transform', translate(xRule.start('content') + x.rangeBand() / 2, yRule.end('content')))
    .enterData(function(s) { return s.values0; }, 'circle', 'point')
      .filter(function(r) {return r != undefined;})
      .attr('fill', function(r) { return getColor(r.c1, color); })
      .attr('r', 5)
      .attr('cx', function(r) { return x(r.c0); })
      .attr('cy', function(r) { return -y(r.c2); })
      .attr('data-click', function(r) { return getClickKeys(r, data.columns); })
      .attr('shape-rendering', 'initial')
      .append('svg:title')
      .text(function(r) { return r.c0.niceToString() + ', ' + r.c1.niceToString() + ': ' + r.c2.niceToString(); });
  
  */
  chart.append('svg:g').attr('class', 'x-axis').attr('transform', translate(xRule.start('content'), yRule.end('content')))
    .append('svg:line')
    .attr('class', 'x-axis')
    .attr('x2', xRule.size('content'))
    .style('stroke', 'Black');
  
  chart.append('svg:g').attr('class', 'y-axis').attr('transform', translate(xRule.start('content'), yRule.start('content')))
    .append('svg:line')
    .attr('class', 'y-axis')
    .attr('y2', yRule.size('content'))
    .style('stroke', 'Black'); 
  
}
]]></Script>
</ChartScript>